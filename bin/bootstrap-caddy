#!/usr/bin/env bash
set -euo pipefail

log() {
  echo "[bootstrap-caddy] $1"
}

OS_ID="$(. /etc/os-release && echo "$ID")"

########################################
# Ensure Debian/Ubuntu
########################################

if [[ "$OS_ID" != "ubuntu" && "$OS_ID" != "debian" ]]; then
  log "Unsupported OS: $OS_ID"
  exit 1
fi

########################################
# Install prerequisites
########################################

if ! command -v caddy >/dev/null 2>&1; then
  log "Installing Caddy"

  sudo apt update -y
  sudo apt install -y \
    debian-keyring \
    debian-archive-keyring \
    apt-transport-https \
    curl \
    gnupg

  curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | \
    sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg

  curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | \
    sudo tee /etc/apt/sources.list.d/caddy-stable.list >/dev/null

  sudo apt update -y
  sudo apt install -y caddy

  log "Caddy installed"
else
  log "Caddy already installed"
fi

########################################
# Ensure config exists but do NOT overwrite
########################################

CADDYFILE="/etc/caddy/Caddyfile"

if [ ! -f "$CADDYFILE" ]; then
  log "Creating empty Caddyfile"
  sudo mkdir -p /etc/caddy
  echo "" | sudo tee "$CADDYFILE" >/dev/null
fi

########################################
# Enable + start service
########################################

if command -v systemctl >/dev/null 2>&1; then
  log "Enabling Caddy service"
  sudo systemctl enable caddy

  log "Starting Caddy"
  sudo systemctl restart caddy
else
  log "systemctl not available â€” skipping service start"
fi

########################################
# Status
########################################

if command -v systemctl >/dev/null 2>&1; then
  log "Caddy status:"
  sudo systemctl --no-pager status caddy | head -n 10 || true
fi

log "bootstrap-caddy complete"
