#!/usr/bin/env bash
set -euo pipefail

log() {
  echo "[bootstrap-caddy] $1"
}

OS_ID="$(. /etc/os-release && echo "$ID")"

########################################
# OS Check
########################################

if [[ "$OS_ID" != "ubuntu" && "$OS_ID" != "debian" ]]; then
  log "Unsupported OS: $OS_ID"
  exit 1
fi

########################################
# Install Caddy (if missing)
########################################

if ! command -v caddy >/dev/null 2>&1; then
  log "Installing Caddy"

  sudo apt update -y
  sudo apt install -y \
    debian-keyring \
    debian-archive-keyring \
    apt-transport-https \
    curl \
    gnupg

  curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | \
    sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg

  curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | \
    sudo tee /etc/apt/sources.list.d/caddy-stable.list >/dev/null

  sudo apt update -y
  sudo apt install -y caddy

  log "Caddy installed"
else
  log "Caddy already installed"
fi

########################################
# Ensure directory structure
########################################

SITE_DIR="/etc/caddy/sites-enabled"
MAIN_CADDYFILE="/etc/caddy/Caddyfile"

sudo mkdir -p "$SITE_DIR"

########################################
# Ensure main Caddyfile exists
########################################

if [ ! -f "$MAIN_CADDYFILE" ]; then
  log "Creating main Caddyfile"

  sudo tee "$MAIN_CADDYFILE" >/dev/null <<EOF
{
    email you@example.com
}

import sites-enabled/*
EOF

else
  # Ensure import line exists
  if ! sudo grep -q "import sites-enabled/\*" "$MAIN_CADDYFILE"; then
    log "Adding sites-enabled import to existing Caddyfile"
    echo "" | sudo tee -a "$MAIN_CADDYFILE" >/dev/null
    echo "import sites-enabled/*" | sudo tee -a "$MAIN_CADDYFILE" >/dev/null
  else
    log "sites-enabled import already present"
  fi
fi

########################################
# Enable + start service
########################################

if command -v systemctl >/dev/null 2>&1; then
  log "Enabling Caddy service"
  sudo systemctl enable caddy

  log "Starting/restarting Caddy"
  sudo systemctl restart caddy
fi

########################################
# Status
########################################

if command -v systemctl >/dev/null 2>&1; then
  log "Caddy status:"
  sudo systemctl --no-pager status caddy | head -n 8 || true
fi

log "bootstrap-caddy complete"
