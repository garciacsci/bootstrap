#!/usr/bin/env bash
set -euo pipefail

SERVICE_DIR="$HOME/.pm2-deploy-services"

for file in "$SERVICE_DIR"/*.env; do
  [ -e "$file" ] || continue

  # shellcheck disable=SC1090
  source "$file"

  echo "Checking updates for $NAME"

  cd "$BASE_DIR"

  git fetch origin "$BRANCH"

  LOCAL=$(git rev-parse HEAD)
  REMOTE=$(git rev-parse "origin/$BRANCH")

  if [ "$LOCAL" != "$REMOTE" ]; then
    echo "Updates found for $NAME"

    git pull origin "$BRANCH"

    pnpm install --frozen-lockfile || pnpm install

    if pm2 describe "$NAME" >/dev/null 2>&1; then
      pm2 restart "$NAME"
    else
      echo "Process $NAME not found in PM2, starting fresh"
      pm2 start "pnpm run $PNPM_SCRIPT" --name "$NAME" --cwd "$BASE_DIR"
    fi
    pm2 save
  else
    echo "No updates for $NAME"
  fi
done
