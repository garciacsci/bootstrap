#!/usr/bin/env bash
set -euo pipefail

USERS_FILE="/etc/caddy/users.json"

log()  { echo "[add-portal-user] $1"; }
fail() { echo "[add-portal-user] Error: $1" >&2; exit 1; }

########################################
# Pre-flight
########################################

[ -f "$USERS_FILE" ] || fail "Users file not found: $USERS_FILE â€” run bootstrap-caddy-security first"

command -v caddy    >/dev/null 2>&1 || fail "caddy not found"
command -v python3  >/dev/null 2>&1 || fail "python3 not found"

########################################
# Gather inputs
########################################

echo
read -rp  "Username: " USERNAME
read -rp  "Email:    " EMAIL

echo
read -rsp "Password: " PASSWORD
echo
read -rsp "Confirm:  " PASSWORD2
echo

[[ "$PASSWORD" == "$PASSWORD2" ]] || fail "Passwords do not match"
[[ -n "$PASSWORD" ]]              || fail "Password cannot be empty"
[[ -n "$USERNAME" ]]              || fail "Username cannot be empty"
[[ -n "$EMAIL" ]]                 || fail "Email cannot be empty"

echo
read -rp "Grant admin role? [y/N] " ADMIN_CHOICE
ROLE="authp/user"
[[ "$ADMIN_CHOICE" =~ ^[Yy]$ ]] && ROLE="authp/admin"

########################################
# Hash password
########################################

HASH=$(caddy hash-password --plaintext "$PASSWORD")
USER_ID=$(cat /proc/sys/kernel/random/uuid 2>/dev/null \
  || python3 -c "import uuid; print(uuid.uuid4())")
NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

########################################
# Write user to JSON store
########################################

TMPFILE=$(mktemp)

python3 - "$USERS_FILE" "$TMPFILE" \
  "$USERNAME" "$EMAIL" "$HASH" "$ROLE" "$USER_ID" "$NOW" <<'PYEOF'
import json, sys

_, users_file, out_file, username, email, hash_val, role, user_id, now = sys.argv

try:
    with open(users_file) as f:
        data = json.load(f)
except (json.JSONDecodeError, FileNotFoundError):
    data = {}

if username in data:
    print(f"Error: user '{username}' already exists", file=sys.stderr)
    sys.exit(1)

roles = [{"name": "authp/user"}]
if role == "authp/admin":
    roles.append({"name": "authp/admin"})

data[username] = {
    "id": user_id,
    "username": username,
    "email": email,
    "email_verified": True,
    "passwords": [
        {
            "purpose": "generic",
            "type": "local",
            "hash_type": "bcrypt",
            "hash": hash_val,
            "expired_at": "0001-01-01T00:00:00Z",
            "created_at": now,
            "disabled": False
        }
    ],
    "roles": roles
}

with open(out_file, "w") as f:
    json.dump(data, f, indent=2)
PYEOF

sudo cp "$TMPFILE" "$USERS_FILE"
sudo chown root:root "$USERS_FILE"
sudo chmod 640 "$USERS_FILE"
rm -f "$TMPFILE"

########################################
# Reload Caddy
########################################

log "Reloading Caddy"
sudo systemctl reload caddy

echo
log "User '$USERNAME' created with role '$ROLE'"
