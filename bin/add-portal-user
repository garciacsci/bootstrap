#!/usr/bin/env bash
set -euo pipefail

USERS_FILE="/var/lib/caddy/users.json"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
HELPER="$SCRIPT_DIR/caddy-security-user"

log()  { echo "[add-portal-user] $1"; }
fail() { echo "[add-portal-user] Error: $1" >&2; exit 1; }

########################################
# Pre-flight
########################################

command -v caddy >/dev/null 2>&1 || fail "caddy not found"
command -v python3 >/dev/null 2>&1 || fail "python3 not found"
[ -x "$HELPER" ] || fail "Helper script not found or not executable: $HELPER"

########################################
# Gather inputs
########################################

echo
read -rp  "Username: " USERNAME
read -rp  "Email:    " EMAIL

echo
read -rsp "Password: " PASSWORD
echo
read -rsp "Confirm:  " PASSWORD2
echo

[[ "$PASSWORD" == "$PASSWORD2" ]] || fail "Passwords do not match"
[[ -n "$PASSWORD" ]]              || fail "Password cannot be empty"
[[ -n "$USERNAME" ]]              || fail "Username cannot be empty"
[[ -n "$EMAIL" ]]                 || fail "Email cannot be empty"

echo
read -rp "Grant admin role? [y/N] " ADMIN_CHOICE
ROLES="authp/user"
[[ "$ADMIN_CHOICE" =~ ^[Yy]$ ]] && ROLES="admin,authp/admin,authp/user"

########################################
# Stop Caddy (prevents DB conflicts)
########################################

log "Stopping Caddy"
sudo systemctl stop caddy

########################################
# Add user via helper script
########################################

log "Adding user '$USERNAME'"

# Create password file for helper
TEMP_PASS=$(mktemp)
echo "$PASSWORD" > "$TEMP_PASS"

# Use our helper script that writes v1.1.x format
sudo python3 "$HELPER" add \
  --db "$USERS_FILE" \
  --username "$USERNAME" \
  --email "$EMAIL" \
  --password "file:$TEMP_PASS" \
  --roles "$ROLES" \
  || fail "Failed to add user"

rm -f "$TEMP_PASS"

# Set proper permissions
sudo chown caddy:caddy "$USERS_FILE"
sudo chmod 600 "$USERS_FILE"

########################################
# Restart Caddy
########################################

log "Starting Caddy"
sudo systemctl start caddy

echo
log "User '$USERNAME' created with roles '$ROLES'"