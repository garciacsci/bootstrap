#!/usr/bin/env bash
set -euo pipefail

USERS_FILE="/var/lib/caddy/users.json"

log()  { echo "[add-portal-user] $1"; }
fail() { echo "[add-portal-user] Error: $1" >&2; exit 1; }

########################################
# Pre-flight
########################################

[ -f "$USERS_FILE" ] || fail "Users file not found: $USERS_FILE — run bootstrap-caddy-security first"

command -v caddy >/dev/null 2>&1 || fail "caddy not found"

########################################
# Gather inputs
########################################

echo
read -rp  "Username: " USERNAME
read -rp  "Email:    " EMAIL

echo
read -rsp "Password: " PASSWORD
echo
read -rsp "Confirm:  " PASSWORD2
echo

[[ "$PASSWORD" == "$PASSWORD2" ]] || fail "Passwords do not match"
[[ -n "$PASSWORD" ]]              || fail "Password cannot be empty"
[[ -n "$USERNAME" ]]              || fail "Username cannot be empty"
[[ -n "$EMAIL" ]]                 || fail "Email cannot be empty"

echo
read -rp "Grant admin role? [y/N] " ADMIN_CHOICE
ROLES="authp/user"
[[ "$ADMIN_CHOICE" =~ ^[Yy]$ ]] && ROLES="authp/admin,authp/user"

########################################
# Stop Caddy (prevents DB conflicts)
########################################

log "Stopping Caddy"
sudo systemctl stop caddy

########################################
# Add user via caddy-security CLI
########################################

log "Adding user '$USERNAME'"

# Create password file for caddy-security
TEMP_PASS=$(mktemp)
echo "$PASSWORD" > "$TEMP_PASS"

# Use caddy-security's user add command
sudo caddy-security add user \
  --db "$USERS_FILE" \
  --username "$USERNAME" \
  --email "$EMAIL" \
  --password "file:$TEMP_PASS" \
  --roles "$ROLES" \
  || fail "Failed to add user — check caddy-security CLI is available"

rm -f "$TEMP_PASS"

########################################
# Restart Caddy
########################################

log "Starting Caddy"
sudo systemctl start caddy

echo
log "User '$USERNAME' created with roles '$ROLES'"
