#!/usr/bin/env bash
set -euo pipefail

SCRIPT_VERSION="0.2.0"

log() {
  echo "[bootstrap-dev] $1"
}

log "bootstrap-dev v$SCRIPT_VERSION start"

OS="$(uname -s)"

########################################
# Base packages (Linux)
########################################

if [[ "$OS" == "Linux" ]] && command -v apt-get >/dev/null 2>&1; then
  log "Installing base packages"
  sudo apt-get update -y
  sudo apt-get install -y \
    curl \
    git \
    ca-certificates \
    gnupg \
    jq \
    build-essential
fi

########################################
# Docker
########################################

if [[ "$OS" == "Linux" ]]; then
  if ! command -v docker >/dev/null 2>&1; then
    log "Installing Docker"
    curl -fsSL https://get.docker.com | sh
    log "Docker installed (run: newgrp docker)"
  else
    log "Docker already installed"
  fi
fi

########################################
# Docker Compose plugin
########################################

if command -v docker >/dev/null 2>&1; then
  if ! docker compose version >/dev/null 2>&1; then
    if command -v apt-get >/dev/null 2>&1; then
      log "Installing Docker Compose plugin"
      sudo apt-get install -y docker-compose-plugin || true
    fi
  else
    log "Docker Compose already available"
  fi
fi

########################################
# Docker buildx (multi-arch builder)
########################################

if command -v systemctl >/dev/null 2>&1 && command -v docker >/dev/null 2>&1; then
  sudo systemctl enable docker || true
  sudo systemctl start docker || true
fi

if command -v docker >/dev/null 2>&1; then
  docker info >/dev/null 2>&1 || sleep 2

  if ! docker buildx version >/dev/null 2>&1; then
    log "Enabling buildx"
    docker buildx inspect multiarch-builder >/dev/null 2>&1 || \
    docker buildx create --use --name multiarch-builder || true
  else
    log "buildx already available"
  fi
fi

########################################
# Install NVM
########################################

export NVM_DIR="$HOME/.nvm"

if [ ! -d "$NVM_DIR" ]; then
  log "Installing NVM"
  curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
fi

# Load NVM
# nvm's shell code references unbound variables, so temporarily relax -u
# shellcheck disable=SC1090
set +u
if [ -s "$NVM_DIR/nvm.sh" ]; then
  . "$NVM_DIR/nvm.sh"
else
  set -u
  log "NVM install finished. Re-run bootstrap-dev in a new shell."
  exit 0
fi

########################################
# Node LTS
########################################

if ! command -v node >/dev/null 2>&1; then
  log "Installing Node LTS"
  nvm install --lts
fi

nvm use --lts
nvm alias default 'lts/*'
set -u

########################################
# Corepack + pnpm
########################################

if command -v corepack >/dev/null 2>&1; then
  log "Enabling corepack"
  corepack enable
fi

if ! command -v pnpm >/dev/null 2>&1; then
  log "Installing pnpm"
  corepack prepare pnpm@latest --activate || npm install -g pnpm
else
  log "pnpm already installed"
fi

########################################
# PM2
########################################

if ! command -v pm2 >/dev/null 2>&1; then
  log "Installing PM2"
  pnpm add -g pm2 || npm install -g pm2
else
  log "PM2 already installed"
fi

pm2 startup || true
pm2 save || true

########################################
# pm2-auto-update cron (every 3 min)
########################################

CRON_CMD="$HOME/bin/pm2-auto-update"
CRON_JOB="*/3 * * * * $CRON_CMD >> /tmp/pm2-auto-update.log 2>&1"
if crontab -l 2>/dev/null | grep -Fq "$CRON_CMD"; then
  log "pm2-auto-update cron already installed"
else
  ( crontab -l 2>/dev/null; echo "$CRON_JOB" ) | crontab -
  log "Installed pm2-auto-update cron (every 5 min)"
fi

########################################
# Optional power tools
########################################

if [[ "$OS" == "Linux" ]] && command -v apt-get >/dev/null 2>&1; then
  if ! command -v gh >/dev/null 2>&1; then
    log "Installing GitHub CLI"
    sudo apt-get install -y gh || true
  fi

  if ! command -v lazygit >/dev/null 2>&1; then
    log "Installing lazygit (if available)"
    sudo apt-get install -y lazygit || true
  fi
fi

########################################
# Verification
########################################

echo
echo "Versions:"
echo "Node: $(node -v 2>/dev/null || echo missing)"
echo "pnpm: $(pnpm -v 2>/dev/null || echo missing)"
echo "PM2: $(pm2 -v 2>/dev/null || echo missing)"
echo "Docker: $(docker --version 2>/dev/null || echo missing)"
echo "Buildx: $(docker buildx version 2>/dev/null || echo missing)"

log "bootstrap-dev complete"

echo
echo "If docker fails, run:"
echo "  newgrp docker"
