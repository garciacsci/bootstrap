#!/usr/bin/env bash
set -euo pipefail

SWAP_SIZE="${1:-1G}"
SWAP_FILE="/swapfile"

log() {
  echo "[bootstrap-swap] $1"
}

log "Requested swap size: $SWAP_SIZE"

########################################
# Check existing swap
########################################

if swapon --show | grep -q "$SWAP_FILE"; then
  log "Swap already active at $SWAP_FILE"
  free -h
  exit 0
fi

########################################
# Create swap file
########################################

if [ -f "$SWAP_FILE" ]; then
  log "Swap file exists but not active"
else
  log "Creating swap file"
  sudo fallocate -l "$SWAP_SIZE" "$SWAP_FILE" 2>/dev/null || \
  sudo dd if=/dev/zero of="$SWAP_FILE" bs=1M count=1024
fi

########################################
# Permissions
########################################

log "Setting permissions"
sudo chmod 600 "$SWAP_FILE"

########################################
# Format
########################################

log "Formatting swap"
sudo mkswap "$SWAP_FILE" || true

########################################
# Enable
########################################

log "Enabling swap"
sudo swapon "$SW
