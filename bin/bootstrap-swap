#!/usr/bin/env bash
set -euo pipefail

SWAP_SIZE="${1:-1G}"
SWAP_FILE="/swapfile"

log() {
  echo "[bootstrap-swap] $1"
}

log "Requested swap size: $SWAP_SIZE"

########################################
# Check existing swap
########################################

if swapon --show | grep -q "$SWAP_FILE"; then
  log "Swap already active at $SWAP_FILE"
  free -h
  exit 0
fi

########################################
# Create swap file
########################################

if [ -f "$SWAP_FILE" ]; then
  log "Swap file exists but not active"
else
  log "Creating swap file"
  sudo fallocate -l "$SWAP_SIZE" "$SWAP_FILE" 2>/dev/null || \
  sudo dd if=/dev/zero of="$SWAP_FILE" bs=1M count=1024
fi

########################################
# Permissions
########################################

log "Setting permissions"
sudo chmod 600 "$SWAP_FILE"

########################################
# Format
########################################

log "Formatting swap"
sudo mkswap "$SWAP_FILE" || true

########################################
# Enable
########################################

log "Enabling swap"
sudo swapon "$SWAP_FILE"

########################################
# Persist in fstab
########################################

if ! grep -q "$SWAP_FILE" /etc/fstab; then
  log "Adding to /etc/fstab"
  echo "$SWAP_FILE none swap sw 0 0" | sudo tee -a /etc/fstab
fi

########################################
# Tune swappiness
########################################

if ! grep -q "vm.swappiness" /etc/sysctl.conf; then
  log "Setting swappiness"
  echo "vm.swappiness=10" | sudo tee -a /etc/sysctl.conf
fi

sudo sysctl vm.swappiness=10

########################################
# Verify
########################################

log "Swap status"
free -h
swapon --show

log "bootstrap-swap complete"
