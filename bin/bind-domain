#!/usr/bin/env bash
set -euo pipefail

DOMAIN="${1:-}"
PORT="${2:-}"

log() {
  echo "[bind-domain] $1"
}

if [[ -z "$DOMAIN" || -z "$PORT" ]]; then
  echo "Usage: bind-domain <domain> <port>"
  exit 1
fi

SITE_DIR="/etc/caddy/sites-enabled"
CONF_FILE="$SITE_DIR/$DOMAIN.conf"

log "Binding $DOMAIN → localhost:$PORT"

sudo mkdir -p "$SITE_DIR"

if [ -f "$CONF_FILE" ]; then
  log "Config already exists for $DOMAIN"
  exit 0
fi

sudo tee "$CONF_FILE" >/dev/null <<EOF
$DOMAIN {
    reverse_proxy 127.0.0.1:$PORT
}
EOF

log "Created $CONF_FILE"

########################################
# Reload Caddy safely
########################################

if command -v systemctl >/dev/null 2>&1; then
  log "Reloading Caddy"
  sudo systemctl reload caddy
else
  log "systemctl not found — restart manually"
fi

log "Done. Caddy will obtain TLS automatically."
