#!/usr/bin/env bash
set -euo pipefail

DOMAIN="${1:-}"
PORT="${2:-}"

log() { echo "[bind-domain-public] $1"; }

is_valid_fqdn() {
  local value="$1"
  [[ "$value" =~ ^[A-Za-z0-9]([A-Za-z0-9-]{0,61}[A-Za-z0-9])?(\.[A-Za-z0-9]([A-Za-z0-9-]{0,61}[A-Za-z0-9])?)+$ ]]
}

[ -z "$DOMAIN" ] || [ -z "$PORT" ] && {
  echo "Usage: bind-domain-public <domain> <port>"
  exit 1
}

if ! is_valid_fqdn "$DOMAIN"; then
  echo "Error: domain must be a fully-qualified domain name (example: app.example.com)"
  exit 1
fi

SITE_DIR="/etc/caddy/sites-enabled"
CONF="$SITE_DIR/$DOMAIN.conf"

sudo mkdir -p "$SITE_DIR"

if [ -f "$CONF" ]; then
  log "Config exists for $DOMAIN"
  exit 0
fi

sudo tee "$CONF" >/dev/null <<EOF
$DOMAIN {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        -Server
    }

    reverse_proxy 127.0.0.1:$PORT
}
EOF

sudo systemctl reload caddy
log "Public route created"
