#!/usr/bin/env bash
set -euo pipefail

DOMAIN="${1:-}"
CONF="/etc/caddy/sites-enabled/$DOMAIN.conf"

[ -z "$DOMAIN" ] && {
  echo "Usage: open-domain <domain>"
  exit 1
}

[ ! -f "$CONF" ] && {
  echo "Config not found"
  exit 1
}

if ! grep -q "basicauth" "$CONF"; then
  echo "Domain is already public"
  exit 0
fi

# Remove the entire basicauth block (handles indentation and multi-line)
TMP=$(mktemp)
sudo awk '
  /basicauth[[:space:]]*\{/ { skip=1; next }
  skip && /\}/              { skip=0; next }
  skip                      { next }
  # Remove blank lines left behind after block removal
  { print }
' "$CONF" | cat -s | sudo tee "$TMP" >/dev/null

sudo mv "$TMP" "$CONF"

if sudo caddy validate --config /etc/caddy/Caddyfile 2>/dev/null; then
  sudo systemctl reload caddy
  echo "Domain is now public"
else
  echo "Caddy config validation failed â€” check $CONF"
  exit 1
fi
