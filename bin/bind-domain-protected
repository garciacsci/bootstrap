#!/usr/bin/env bash
set -euo pipefail

DOMAIN="${1:-}"
PORT="${2:-}"

log() { echo "[bind-domain-protected] $1"; }

is_valid_fqdn() {
  local value="$1"
  [[ "$value" =~ ^[A-Za-z0-9]([A-Za-z0-9-]{0,61}[A-Za-z0-9])?(\.[A-Za-z0-9]([A-Za-z0-9-]{0,61}[A-Za-z0-9])?)+$ ]]
}

[ -z "$DOMAIN" ] || [ -z "$PORT" ] && {
  echo "Usage: bind-domain-protected <domain> <port>"
  exit 1
}

if ! is_valid_fqdn "$DOMAIN"; then
  echo "Error: domain must be a fully-qualified domain name (example: app.example.com)"
  exit 1
fi

SITE_DIR="/etc/caddy/sites-enabled"
CONF="$SITE_DIR/$DOMAIN.conf"

sudo mkdir -p "$SITE_DIR"

if [ -f "$CONF" ]; then
  log "Config exists for $DOMAIN"
  exit 0
fi

if ! sudo grep -q 'authorize with caddy-policy' /etc/caddy/Caddyfile 2>/dev/null \
   && ! sudo grep -rq 'authorize with caddy-policy' "$SITE_DIR" 2>/dev/null; then
  log "Warning: caddy-security does not appear to be configured."
  log "Run bootstrap-caddy-security <base-domain> first."
  exit 1
fi

sudo tee "$CONF" >/dev/null <<EOF
$DOMAIN {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        -Server
    }

    authorize with caddy-policy

    reverse_proxy 127.0.0.1:$PORT
}
EOF

sudo caddy validate --config /etc/caddy/Caddyfile 2>/dev/null \
  && sudo systemctl reload caddy \
  || { log "Caddy config invalid â€” check $CONF"; exit 1; }

log "Protected route created (caddy-security portal auth)"
