#!/usr/bin/env bash
set -euo pipefail

DOMAIN="${1:-}"

log() {
  echo "[protect-domain] $1"
}

if [[ -z "$DOMAIN" ]]; then
  echo "Usage: protect-domain <domain>"
  exit 1
fi

CONF_FILE="/etc/caddy/sites-enabled/$DOMAIN.conf"

if [ ! -f "$CONF_FILE" ]; then
  log "Config not found for $DOMAIN"
  exit 1
fi

########################################
# Require caddy-security to be bootstrapped
########################################

if ! sudo grep -q 'authorization policy caddy-policy' /etc/caddy/Caddyfile 2>/dev/null; then
  log "caddy-security is not configured."
  log "Run: bootstrap-caddy-security <base-domain>"
  exit 1
fi

if grep -q 'authorize with caddy-policy' "$CONF_FILE"; then
  log "$DOMAIN is already protected with caddy-policy"
  exit 0
fi

TMP_FILE=$(mktemp)

########################################
# Strip any existing basic_auth / basicauth block
########################################

sudo awk '
  /basic_auth[[:space:]]*(\{|$)|basicauth[[:space:]]*(\{|$)/ { skip=1; next }
  skip && /\}/ { skip=0; next }
  skip         { next }
  { print }
' "$CONF_FILE" | cat -s | sudo tee "$TMP_FILE" >/dev/null

########################################
# Inject authorize directive after site opening brace
########################################

sudo awk '
  /\{/ && !done {
    print
    print ""
    print "    authorize with caddy-policy"
    done=1
    next
  }
  { print }
' "$TMP_FILE" | sudo tee "$CONF_FILE" >/dev/null

rm -f "$TMP_FILE"

########################################
# Validate and reload Caddy
########################################

if sudo caddy validate --config /etc/caddy/Caddyfile 2>/dev/null; then
  log "Reloading Caddy"
  sudo systemctl reload caddy
  log "Protection enabled for $DOMAIN (caddy-security portal auth)"
else
  log "Caddy config validation failed â€” check $CONF_FILE"
  exit 1
fi
