#!/usr/bin/env bash
set -euo pipefail

DOMAIN="${1:-}"

log() {
  echo "[protect-domain] $1"
}

if [[ -z "$DOMAIN" ]]; then
  echo "Usage: protect-domain <domain>"
  exit 1
fi

CONF_FILE="/etc/caddy/sites-enabled/$DOMAIN.conf"

if [ ! -f "$CONF_FILE" ]; then
  log "Config not found for $DOMAIN"
  exit 1
fi

echo
read -rp "Username: " USERNAME
echo
echo "Enter password for $USERNAME"
echo

HASH=$(caddy hash-password)

TMP_FILE=$(mktemp)

########################################
# Remove existing basicauth block (if any), then inject fresh
########################################

# Step 1: strip any existing basicauth block
sudo awk '
  /basicauth[[:space:]]*\{/ { skip=1; next }
  skip && /\}/              { skip=0; next }
  skip                      { next }
  { print }
' "$CONF_FILE" | cat -s | sudo tee "$TMP_FILE" >/dev/null

# Step 2: inject new basicauth block after the opening brace
sudo awk -v user="$USERNAME" -v hash="$HASH" '
  /\{/ && !done {
    print
    print ""
    print "    basicauth {"
    print "        " user " " hash
    print "    }"
    done=1
    next
  }
  { print }
' "$TMP_FILE" | sudo tee "$CONF_FILE" >/dev/null

rm -f "$TMP_FILE"

########################################
# Validate and reload Caddy
########################################

if sudo caddy validate --config /etc/caddy/Caddyfile 2>/dev/null; then
  log "Reloading Caddy"
  sudo systemctl reload caddy
  log "Protection enabled for $DOMAIN"
else
  log "Caddy config validation failed â€” check $CONF_FILE"
  exit 1
fi
